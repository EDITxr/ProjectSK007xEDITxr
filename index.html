<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Stickykodes | Ultimate Mixed Reality Architecture</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* =========================================
           STICKYKODES CORE CSS ARCHITECTURE
           ========================================= */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }

        body, html { 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background-color: transparent !important; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        }

        /* --- BLUR OVERLAY --- */
        #mr-blur-overlay { 
            position: fixed; 
            inset: 0; 
            z-index: 5; 
            pointer-events: none; 
            transition: all 0.7s cubic-bezier(0.25, 1, 0.5, 1); 
            background: radial-gradient(circle, rgba(0,0,0,0) 20%, rgba(0,0,0,0.8) 100%); 
            backdrop-filter: blur(0px); 
            opacity: 0; 
        }

        #mr-blur-overlay.active { 
            opacity: 1; 
            backdrop-filter: blur(15px); 
            -webkit-mask-image: radial-gradient(circle, transparent 25%, black 80%); 
            mask-image: radial-gradient(circle, transparent 25%, black 80%);
        }

        /* --- ZOOM CONTROLS --- */
        #zoom-btn { 
            position: fixed; 
            bottom: 40px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            background: rgba(0, 0, 0, 0.75); 
            color: white; 
            font-weight: 900; 
            font-size: 16px; 
            border: 2px solid rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(12px); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 30; 
            opacity: 0; 
            pointer-events: none; 
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
            box-shadow: 0 4px 20px rgba(0,0,0,0.5); 
            cursor: pointer; 
        }

        #zoom-btn.visible { 
            opacity: 1; 
            pointer-events: auto; 
        }

        #zoom-btn:active { 
            transform: translateX(-50%) scale(0.9); 
        }

        /* --- HUD MENU --- */
        #hud-menu { 
            position: fixed; 
            bottom: 40px; 
            left: 0; 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 18px; 
            z-index: 40; 
            opacity: 0; 
            transform: translateY(50px); 
            transition: all 0.6s cubic-bezier(0.25, 1, 0.5, 1); 
            pointer-events: none; 
        }

        #hud-menu.visible { 
            opacity: 1; 
            transform: translateY(0); 
            pointer-events: auto; 
        }

        .btn-mode { 
            background: rgba(255, 255, 255, 0.12); 
            color: white; 
            border: 1px solid rgba(255, 255, 255, 0.4); 
            padding: 16px 45px; 
            border-radius: 50px; 
            font-weight: bold; 
            font-size: 14px; 
            backdrop-filter: blur(20px); 
            cursor: pointer; 
            transition: 0.3s; 
            letter-spacing: 1px; 
        }

        .btn-mode.active { 
            background: #10b981; 
            border-color: #10b981; 
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.6); 
        }

        .btn-release { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            padding: 20px 70px; 
            border-radius: 50px; 
            font-weight: 900; 
            font-size: 15px; 
            letter-spacing: 3px; 
            box-shadow: 0 12px 30px rgba(59, 130, 246, 0.5); 
            cursor: pointer; 
            transition: transform 0.2s; 
        }

        .btn-release:active { 
            transform: scale(0.95); 
        }

        /* --- BOOT SCREEN --- */
        #boot-screen { 
            position: fixed; 
            inset: 0; 
            background: #000; 
            z-index: 9999; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            transition: opacity 0.8s ease; 
        }

        #boot-btn { 
            padding: 22px 60px; 
            background: #3b82f6; 
            color: white; 
            border: none; 
            border-radius: 100px; 
            font-weight: 900; 
            letter-spacing: 5px; 
            font-size: 14px; 
            box-shadow: 0 0 50px rgba(59, 130, 246, 0.6); 
            cursor: pointer; 
        }

        #status-pill { 
            position: fixed; 
            top: 40px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(0,0,0,0.85); 
            color: white; 
            font-size: 11px; 
            letter-spacing: 4px; 
            padding: 12px 30px; 
            border-radius: 50px; 
            z-index: 100; 
            pointer-events: none; 
            border: 1px solid rgba(255,255,255,0.2); 
            backdrop-filter: blur(8px);
            white-space: nowrap; 
            transition: all 0.3s ease;
        }

        /* --- SANDBOX WRAPPER --- */
        #sk-sandbox-wrapper { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            opacity: 0; 
            pointer-events: none; 
            z-index: -1; 
            width: 90vw; 
            max-width: 420px; 
            height: auto; 
            max-height: 75vh; 
            border-radius: 20px; 
            overflow-y: auto; 
            overflow-x: hidden; 
            box-shadow: 0 35px 80px rgba(0,0,0,0.85); 
            border: 1px solid rgba(255,255,255,0.2); 
            background: #ffffff; 
            will-change: transform, opacity; 
            transform: translate(-50%, -50%) scale(0.4); 
        }

        #sk-sandbox-wrapper::-webkit-scrollbar { 
            display: none; 
        }

        .sandbox-content { 
            padding: 28px; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            color: #111; 
            width: 100%; 
            text-align: left; 
        }

        .sandbox-content h2 { 
            font-size: 28px; 
            font-weight: 900; 
            color: #3b82f6; 
            line-height: 1.1; 
        }

        .sandbox-content p { 
            font-size: 16px; 
            line-height: 1.7; 
            color: #333; 
        }

        .media-container { 
            width: 100%; 
            border-radius: 14px; 
            overflow: hidden; 
            background: #e8e8e8; 
            aspect-ratio: 16 / 9; 
            position: relative; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05); 
        }

        .media-container img, .media-container iframe, .media-container video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            border: none; 
            display: block; 
        }

        .play-overlay { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 60px; 
            height: 60px; 
            background: rgba(59, 130, 246, 0.9); 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            color: white; 
            font-size: 24px; 
            pointer-events: none; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
        }

        .sandbox-btn-main { 
            width: 100%; 
            padding: 18px; 
            background: #111; 
            color: white; 
            font-weight: bold; 
            border-radius: 12px; 
            border: none; 
            font-size: 16px; 
            cursor: pointer; 
        }

        /* --- MEDIA SELECTOR --- */
        #media-selector { 
            padding: 15px; 
            border-radius: 10px; 
            background: #222; 
            color: white; 
            border: 1px solid #444; 
            margin-bottom: 30px; 
            font-size: 15px; 
            outline: none; 
            width: 300px; 
            text-align: center; 
        }
        
        /* --- SCI-FI HOLOGRAPHIC PLAYER (HIGHLY ROUNDED) --- */
        .holo-stable-player {
            background: rgba(10, 10, 10, 0.75); 
            border: 1px solid rgba(0, 255, 204, 0.4);
            border-radius: 35px; /* Extremely smooth rounded corners */
            padding: 30px; 
            display: flex; 
            flex-direction: column; 
            gap: 20px;
            color: white; 
            box-shadow: 0 20px 50px rgba(0, 255, 204, 0.15), inset 0 0 20px rgba(0,255,204,0.05); 
            backdrop-filter: blur(25px);
            overflow: hidden;
        }

        .holo-top { 
            display: flex; 
            align-items: center; 
            gap: 20px; 
        }

        .holo-cover { 
            width: 100px; 
            height: 100px; 
            border-radius: 20px; /* Smooth inner cover art */
            box-shadow: 0 0 25px rgba(0, 255, 204, 0.3); 
            object-fit: cover; 
        }

        .holo-info { 
            text-align: left; 
        }

        .holo-title { 
            color: #00ffcc; 
            font-size: 22px; 
            font-weight: 900; 
            margin-bottom: 5px; 
            text-transform: uppercase; 
            letter-spacing: 2px;
        }

        .holo-artist { 
            color: #888; 
            font-size: 14px; 
            letter-spacing: 1px;
        }

        /* --- 3DPNG ANIMATION --- */
        @keyframes rotate3dpng {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }

        .animated-3dpng {
            animation: rotate3dpng 6s linear infinite;
            filter: drop-shadow(0 20px 40px rgba(0,255,204,0.4));
        }

    </style>
</head>
<body>

    <div id="boot-screen">
        <h1 style="color:white; margin-bottom:20px; letter-spacing:10px; font-weight:100;">STICKYKODES</h1>
        
        <select id="media-selector">
            <option value="html">Original HTML Text Layout</option>
            <option value="png">Floating PNG (True Transparent)</option>
            <option value="3dpng">Animated 3D Hologram (PNG)</option> <option value="jpg">Standalone Image (JPG)</option>
            <option value="mp4">Standalone Video (MP4)</option>
            <option value="youtube">Live YouTube Iframe</option>
            <option value="spotify">Sci-Fi Holographic Music Player</option>
            <option value="science">Quantum Atom (3D Science Model)</option> </select>

        <button id="boot-btn">ENABLE SENSORS</button>
    </div>

    <div id="status-pill">SYSTEM OFFLINE</div>
    <div id="mr-blur-overlay"></div>
    <button id="zoom-btn">1X</button>

    <div id="hud-menu">
        <button class="btn-mode" id="stable-btn">STABLE: OFF</button>
        <button class="btn-release" id="release-btn">RELEASE VIEW</button>
    </div>

    <div id="sk-sandbox-wrapper">
        <div class="sandbox-content" id="sandbox-target"></div>
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: /PlayStation/webAR/assets/targets4.mind; autoStart: false; uiScanning: no; filterMinCF:0.0001; filterBeta: 0.001;" 
        embedded color-space="sRGB" 
        renderer="alpha: true; antialias: true; colorManagement: true; physicallyCorrectLights: true; shadowMapType: pcfsoft;" 
        shadow="type: pcfsoft; autoUpdate: true;"
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">
        
        <a-assets id="dynamic-ar-assets">
            <canvas id="sandbox-texture-canvas"></canvas>
        </a-assets>

        <a-light type="ambient" intensity="0.5"></a-light>
        <a-entity 
            light="type: directional; castShadow: true; intensity: 1.0; shadowMapHeight: 2048; shadowMapWidth: 2048; shadowCameraLeft: -2; shadowCameraRight: 2; shadowCameraBottom: -2; shadowCameraTop: 2;" 
            position="1 4 3">
        </a-entity>
        <a-light type="directional" intensity="0.3" position="-2 -1 -2" color="#bde0fe"></a-light>

        <a-camera id="main-cam" position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0" id="target-marker">
            <a-plane position="0 0 -0.01" width="5" height="5" shadow="receive: true" material="shader: shadow; opacity: 0.4; transparent: true;"></a-plane>

            <a-entity id="cloth-rig">
                <a-entity id="hover-rig"
                         animation__float="property: position; from: 0 0 0.02; to: 0 0 0.06; dir: alternate; dur: 2800; loop: true; easing: easeInOutSine"
                         animation__wave="property: rotation; from: -1.5 -1.5 0; to: 1.5 1.5 0; dir: alternate; dur: 3800; loop: true; easing: easeInOutQuad">
                    
                    <a-entity id="physical-card-backing" 
                              shadow="cast: true" 
                              geometry="primitive: box; width: 0.62; height: 0.8; depth: 0.015" 
                              material="color: #ffffff; roughness: 0.3; metalness: 0.1">
                    </a-entity>
                    
                    <a-plane id="mr-sandbox-mesh" 
                             src="#sandbox-texture-canvas" 
                             position="0 0 0.009" 
                             material="shader: standard; roughness: 0.9; metalness: 0.0">
                    </a-plane>

                    <a-entity id="standalone-media-container" position="0 0 0.01"></a-entity>

                </a-entity>
            </a-entity>
        </a-entity>
    </a-scene>

    <script>
        /**
         * =========================================
         * GLOBAL STATE & ELEMENT MAPPING
         * =========================================
         */
        const elements = {
            bootBtn: document.getElementById('boot-btn'),
            mediaSelector: document.getElementById('media-selector'),
            status: document.getElementById('status-pill'),
            zoom: document.getElementById('zoom-btn'),
            blur: document.getElementById('mr-blur-overlay'),
            menu: document.getElementById('hud-menu'),
            stable: document.getElementById('stable-btn'),
            release: document.getElementById('release-btn'),
            sandbox: document.getElementById('sk-sandbox-wrapper'),
            target: document.getElementById('sandbox-target'),
            mesh: document.getElementById('mr-sandbox-mesh'),
            backing: document.getElementById('physical-card-backing'),
            canvas: document.getElementById('sandbox-texture-canvas'),
            scene: document.querySelector('a-scene'),
            marker: document.getElementById('target-marker'),
            rig: document.getElementById('cloth-rig'),
            arAssets: document.getElementById('dynamic-ar-assets'),
            standalone: document.getElementById('standalone-media-container')
        };

        const config = { 
            STATES: { AR: 'AR', IMMERSIVE: 'IMMERSIVE', STABLE: 'STABLE' }, 
            BASE_WIDTH: 0.6, 
            TRANS_SCALE: 0.3 
        };

        let state = config.STATES.AR;
        let isMarkerFound = false;
        let zoomLevel = 1;
        let inTransition = false;
        let activeMediaEl = null;

        // Gesture State Variables
        let isPinched = false;
        let isPayloadGrabbed = false; // TRUE means user holds the AR object (even between rooms)
        let handsTracker = null;

        // Demo Media Links
        const demoUrls = {
            png: '/PlayStation/webAR/assets/png.png',
            jpg: '/PlayStation/webAR/assets/img2.jpg',
            mp4: '/PlayStation/webAR/assets/mp4.mp4',
            youtubeId: 'dQw4w9WgXcQ', 
            audio: 'https://commondatastorage.googleapis.com/codeskulptor-assets/Epoq-Lepidoptera.ogg',
            coverArt: 'https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=500'
        };

        /**
         * HELPER: Generates the Thin Environmental Frames for media files
         */
        function buildEnvironmentalFrame(width, height) {
            const fw = width + 0.04;
            const fh = height + 0.04;
            return `
                <a-entity position="0 0 -0.005">
                    <a-entity geometry="primitive: plane; width: ${fw}; height: ${fh}" 
                              material="color: #00ffcc; wireframe: true; wireframeLinewidth: 2; emissive: #00ffcc; emissiveIntensity: 0.8; transparent: true; opacity: 0.7">
                    </a-entity>
                    <a-entity geometry="primitive: plane; width: ${fw}; height: ${fh}" 
                              material="color: #000000; opacity: 0.4; transparent: true" position="0 0 -0.001">
                    </a-entity>
                </a-entity>
            `;
        }

        /**
         * =========================================
         * TEXTURE ENGINE & SCENE COMPOSITION
         * =========================================
         */
        async function update3DTexture() {
            const mode = elements.mediaSelector.value;

            // Reset Environment to default
            elements.backing.setAttribute('visible', 'true');
            elements.mesh.setAttribute('visible', 'true');
            elements.standalone.innerHTML = '';
            elements.arAssets.innerHTML = `<canvas id="sandbox-texture-canvas"></canvas>`; 
            elements.sandbox.style.background = '#ffffff';
            elements.sandbox.style.boxShadow = '0 35px 80px rgba(0,0,0,0.85)';
            elements.sandbox.style.border = '1px solid rgba(255,255,255,0.2)';
            activeMediaEl = null;

            if (mode === 'html') {
                elements.target.innerHTML = `
                    <h2>Stickykode XR</h2>
                    <p>Unified Mixed Reality Architecture. Physical 3D lighting meets native HTML responsiveness.</p>
                    <div class="media-container"><img src="${demoUrls.jpg}" crossorigin="anonymous"><div class="play-overlay">â–¶</div></div>
                    <button class="sandbox-btn-main">Visit STICKYKODES.com</button>
                `;

                const originalStyles = { tf: elements.sandbox.style.transform, z: elements.sandbox.style.zIndex, w: elements.sandbox.style.width, maxW: elements.sandbox.style.maxWidth, op: elements.sandbox.style.opacity };
                elements.sandbox.style.transition = 'none'; elements.sandbox.style.zIndex = '-9999'; elements.sandbox.style.opacity = '1'; elements.sandbox.style.transform = 'translate(-50%, -50%) scale(1)'; elements.sandbox.style.width = '400px'; elements.sandbox.style.maxWidth = '400px';

                try {
                    await new Promise(r => setTimeout(r, 200));
                    const capture = await html2canvas(elements.target, { backgroundColor: '#ffffff', scale: 2, width: 400 });
                    const ctx = elements.canvas.getContext('2d');
                    elements.canvas.width = capture.width; elements.canvas.height = capture.height;
                    ctx.drawImage(capture, 0, 0);

                    const aspect = capture.height / capture.width;
                    const h = config.BASE_WIDTH * aspect;

                    elements.mesh.setAttribute('src', '#sandbox-texture-canvas');
                    elements.mesh.setAttribute('width', config.BASE_WIDTH);
                    elements.mesh.setAttribute('height', h);
                    elements.backing.setAttribute('geometry', `primitive: box; width: ${config.BASE_WIDTH + 0.03}; height: ${h + 0.03}; depth: 0.015`);
                } catch (e) { console.error(e); } finally {
                    elements.sandbox.style.width = originalStyles.w; elements.sandbox.style.maxWidth = originalStyles.maxW; elements.sandbox.style.transform = originalStyles.tf; elements.sandbox.style.zIndex = originalStyles.z;
                    if (state !== config.STATES.STABLE) elements.sandbox.style.opacity = originalStyles.op;
                }

            } else {
                elements.backing.setAttribute('visible', 'false'); 
                elements.mesh.setAttribute('visible', 'false');    
                
                elements.sandbox.style.background = 'transparent';
                elements.sandbox.style.boxShadow = 'none';
                elements.sandbox.style.border = 'none';

                if (mode === 'png') {
                 const img = new Image();

img.onload = () =>
{
    const aspect = img.height / img.width;
    
    let width = 0.6;
    let height = width * aspect;
    
    const maxHeight = 1.2;
    
    if (height > maxHeight)
    {
        height = maxHeight;
        width = height / aspect;
    }
    
    elements.standalone.innerHTML = `
        <a-image
            src="${demoUrls.png}"
            width="${width}"
            height="${height}"
            shadow="cast: true"
            material="alphaTest: 0.5; transparent: true;">
        </a-image>
    `;
    
    elements.target.innerHTML =
        `<img src="${demoUrls.png}" style="width:100%; height:auto; filter: drop-shadow(0 20px 30px rgba(0,0,0,0.5));">`;
};

img.src = demoUrls.png;
                } 
                else if (mode === '3dpng') {
                    const img = new Image();

img.onload = () =>
{
    const aspect = img.height / img.width;
    
    let width = 0.6;
    let height = width * aspect;
    
    const maxHeight = 1.2;
    
    if (height > maxHeight)
    {
        height = maxHeight;
        width = height / aspect;
    }
    
    elements.standalone.innerHTML = `
        <a-entity animation="property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear">

            <a-image
                src="${demoUrls.png}"
                width="${width}"
                height="${height}"
                shadow="cast: true"
                material="alphaTest: 0.5; transparent: true; side: double">
            </a-image>

        </a-entity>
    `;
    
    elements.target.innerHTML =
        `<img src="${demoUrls.png}" style="width:100%; height:auto;" class="animated-3dpng">`;
};

img.src = demoUrls.png;
                    elements.target.innerHTML = `<img src="${demoUrls.png}" class="animated-3dpng" style="width:100%;">`;
                }
                else if (mode === 'jpg') {
                 const img = new Image();

img.onload = () =>
{
    const aspect = img.height / img.width;
    
    let width = 0.6;
    let height = width * aspect;
    
    const maxHeight = 1.2;
    
    if (height > maxHeight)
    {
        height = maxHeight;
        width = height / aspect;
    }
    
    elements.standalone.innerHTML = `
        ${buildEnvironmentalFrame(width, height)}

        <a-image
            src="${demoUrls.jpg}"
            width="${width}"
            height="${height}"
            shadow="cast: true">
        </a-image>
    `;
    
    elements.target.innerHTML =
        `<img src="${demoUrls.jpg}" style="width:100%; height:auto; border-radius:14px;">`;
};

img.src = demoUrls.jpg;                    elements.target.innerHTML = `<img src="${demoUrls.jpg}" style="width:100%; border-radius: 14px; box-shadow: 0 20px 50px rgba(0,255,204,0.3); border: 1px solid #00ffcc;">`;
                }
                else if (mode === 'mp4') {
           elements.arAssets.innerHTML += `
<video id="ar-vid"
src="${demoUrls.mp4}"
crossorigin="anonymous"
loop
playsinline
webkit-playsinline>
</video>
`;

const vid = document.getElementById("ar-vid");

vid.onloadedmetadata = () =>
{
    const videoWidth = vid.videoWidth;
    const videoHeight = vid.videoHeight;
    
    const aspect = videoHeight / videoWidth;
    
    const baseWidth = 0.8;
    const computedHeight = baseWidth * aspect;
    
    elements.standalone.innerHTML = `
        ${buildEnvironmentalFrame(baseWidth, computedHeight)}
        <a-video
            src="#ar-vid"
            width="${baseWidth}"
            height="${computedHeight}"
            shadow="cast: true">
        </a-video>
    `;
};

activeMediaEl = vid;
                    elements.target.innerHTML = `<video src="${demoUrls.mp4}" style="width:100%; border-radius: 14px; box-shadow: 0 20px 50px rgba(0,255,204,0.3); border: 1px solid #00ffcc;" controls autoplay loop></video>`;
                    activeMediaEl = document.getElementById('ar-vid');
                }
                else if (mode === 'youtube') {
                    const thumb = `http://googleusercontent.com/youtube.com/4{demoUrls.youtubeId}/maxresdefault.jpg`;
                    const iframe = `http://googleusercontent.com/youtube.com/5{demoUrls.youtubeId}?autoplay=1&enablejsapi=1`;
                    elements.standalone.innerHTML = `
                        ${buildEnvironmentalFrame(0.8, 0.45)}
                        <a-image src="${thumb}" width="0.8" height="0.45" shadow="cast: true"></a-image>
                    `;
                    elements.target.innerHTML = `<div class="media-container" style="border-radius:14px; box-shadow: 0 20px 50px rgba(0,255,204,0.3); border: 1px solid #00ffcc;"><iframe src="${iframe}" allow="autoplay; fullscreen"></iframe></div>`;
                }
                else if (mode === 'spotify') {
                    elements.arAssets.innerHTML += `<audio id="ar-audio" src="${demoUrls.audio}" crossorigin="anonymous" loop></audio>`;
                    elements.standalone.innerHTML = `
                        ${buildEnvironmentalFrame(0.75, 0.3)}
                        <a-entity position="0 0 0">
                            <a-plane width="0.75" height="0.3" material="color: #050505; opacity: 0.85; transparent: true; roughness: 0.1;" shadow="cast: true"></a-plane>
                            <a-image src="${demoUrls.coverArt}" position="-0.22 0 0.01" width="0.2" height="0.2" shadow="cast: true"></a-image>
                            <a-text value="CYBER TRACK" position="-0.08 0.06 0.01" width="1.2" color="#00ffcc"></a-text>
                            <a-text value="Unknown Artist" position="-0.08 0.01 0.01" width="0.9" color="#aaaaaa"></a-text>
                            <a-plane width="0.4" height="0.005" position="0.12 -0.05 0.01" color="#333"></a-plane>
                            <a-plane width="0.15" height="0.005" position="-0.005 -0.05 0.012" color="#00ffcc"></a-plane>
                            <a-circle radius="0.025" position="0.12 -0.09 0.01" color="#00ffcc"></a-circle>
                            <a-triangle vertex-a="0 0.01 0" vertex-b="-0.01 -0.008 0" vertex-c="0.01 -0.008 0" rotation="0 0 -90" position="0.125 -0.09 0.012" color="#000"></a-triangle>
                        </a-entity>
                    `;
                    elements.target.innerHTML = `
                        <div class="holo-stable-player">
                            <div class="holo-top">
                                <img src="${demoUrls.coverArt}" class="holo-cover">
                                <div class="holo-info">
                                    <div class="holo-title">Cyber Track</div>
                                    <div class="holo-artist">Unknown Artist</div>
                                </div>
                            </div>
                            <audio src="${demoUrls.audio}" controls autoplay loop style="width:100%; outline:none; border-radius: 50px;"></audio>
                        </div>
                    `;
                    activeMediaEl = document.getElementById('ar-audio');
                }
                else if (mode === 'science') {
                    elements.standalone.innerHTML = `
                        <a-entity scale="0.4 0.4 0.4" position="0 0 0.1">
                            <a-sphere radius="0.15" material="color: #ff0055; emissive: #ff0055; emissiveIntensity: 1; roughness: 0.2" 
                                      animation="property: scale; dir: alternate; dur: 800; to: 1.2 1.2 1.2; loop: true; easing: easeInOutSine"
                                      shadow="cast: true"></a-sphere>
                            
                            <a-entity animation="property: rotation; to: 360 360 0; loop: true; dur: 4000; easing: linear">
                                <a-torus radius="0.6" radius-tubular="0.005" material="color: #00ffcc; emissive: #00ffcc; emissiveIntensity: 0.6"></a-torus>
                                <a-sphere radius="0.06" position="0.6 0 0" material="color: #ffffff; emissive: #ffffff; emissiveIntensity: 1"></a-sphere>
                            </a-entity>

                            <a-entity animation="property: rotation; to: 0 360 360; loop: true; dur: 5500; easing: linear">
                                <a-torus radius="0.6" radius-tubular="0.005" material="color: #00ffcc; emissive: #00ffcc; emissiveIntensity: 0.6"></a-torus>
                                <a-sphere radius="0.06" position="0 0.6 0" material="color: #ffffff; emissive: #ffffff; emissiveIntensity: 1"></a-sphere>
                            </a-entity>

                            <a-entity animation="property: rotation; to: 360 0 360; loop: true; dur: 4800; easing: linear">
                                <a-torus radius="0.6" radius-tubular="0.005" material="color: #00ffcc; emissive: #00ffcc; emissiveIntensity: 0.6"></a-torus>
                                <a-sphere radius="0.06" position="0 0 0.6" material="color: #ffffff; emissive: #ffffff; emissiveIntensity: 1"></a-sphere>
                            </a-entity>
                        </a-entity>
                    `;

                    elements.target.innerHTML = `
                        <div class="holo-stable-player" style="text-align: center;">
                            <h2 style="color:#00ffcc; margin-bottom: 15px; font-weight: 900; letter-spacing: 2px;">QUANTUM ATOM</h2>
                            <p style="color:#ccc; line-height: 1.6;">
                                Real-time dynamic 3D molecular model running in AR spatial memory.<br><br>
                                Release view to observe orbital mechanics mapping over the Stickykode marker.
                            </p>
                        </div>
                    `;
                }
            }
        }

        /**
         * =========================================
         * MEDIAPIPE CROSS-ROOM GESTURE ENGINE
         * =========================================
         */
        function initializeHandTracking() {
            handsTracker = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});

            handsTracker.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.6,
                minTrackingConfidence: 0.6
            });

            handsTracker.onResults(onHandResults);
            
            // Hook into the AR engine's video stream once it starts
            const checkVideo = setInterval(() => {
                const videoEl = document.querySelector('video');
                if (videoEl && videoEl.readyState >= 2) {
                    clearInterval(checkVideo);
                    async function sendFrame() {
                        if (!videoEl.paused && !videoEl.ended) {
                            await handsTracker.send({image: videoEl});
                        }
                        requestAnimationFrame(sendFrame);
                    }
                    sendFrame();
                }
            }, 500);
        }

        function onHandResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const thumbTip = landmarks[4];
                const indexTip = landmarks[8];
                
                const distance = Math.sqrt(
                    Math.pow(thumbTip.x - indexTip.x, 2) +
                    Math.pow(thumbTip.y - indexTip.y, 2)
                );

                const pinchThreshold = 0.05;
                
                if (distance < pinchThreshold && !isPinched) {
                    isPinched = true;
                    // Grab ONLY if we see a marker and haven't already grabbed something
                    if (isMarkerFound && !isPayloadGrabbed) {
                        handlePinchStart();
                    }
                    updateStatusPill();
                } else if (distance > pinchThreshold * 1.5 && isPinched) {
                    isPinched = false;
                    // Drop ONLY if we are holding something AND actively looking at a marker
                    if (isPayloadGrabbed && isMarkerFound) {
                        handlePinchEnd();
                    }
                    updateStatusPill();
                }
            }
        }

        function handlePinchStart() {
            isPayloadGrabbed = true; // Secured in memory
            if (state !== config.STATES.STABLE) {
                elements.rig.setAttribute('visible', 'false');
            }
            if (activeMediaEl) activeMediaEl.pause();
        }

        function handlePinchEnd() {
            isPayloadGrabbed = false; // Successfully deployed
            if (state !== config.STATES.STABLE) {
                elements.rig.setAttribute('visible', 'true');
                if (activeMediaEl) activeMediaEl.play();
            }
        }

        function updateStatusPill() {
            if (isPayloadGrabbed && !isMarkerFound) {
                // Walking between rooms / holding payload while searching
                elements.status.innerText = "PAYLOAD SECURED: FIND STICKER";
                elements.status.style.color = "#f59e0b"; // amber
            } else if (isPayloadGrabbed && isMarkerFound) {
                // Found a sticker, preparing to drop
                if (isPinched) {
                    elements.status.innerText = "RELEASE TO DROP";
                } else {
                    elements.status.innerText = "PINCH & RELEASE TO DROP";
                }
                elements.status.style.color = "#fbbf24"; // yellow
            } else if (isMarkerFound) {
                // Normal viewing state
                elements.status.innerText = "STICKER LOCKED";
                elements.status.style.color = "#34d399"; // green
            } else {
                elements.status.innerText = "SCANNING...";
                elements.status.style.color = "white";
            }
        }

        /**
         * =========================================
         * INITIALIZATION & BOOT SEQUENCE
         * =========================================
         */
        elements.bootBtn.onclick = async () => {
            elements.bootBtn.innerText = "CALIBRATING...";
            elements.bootBtn.disabled = true;
            await update3DTexture();

            if (activeMediaEl) { 
                activeMediaEl.play().catch(()=>{}); 
                activeMediaEl.pause(); 
            }

            document.getElementById('boot-screen').style.opacity = '0';
            setTimeout(() => document.getElementById('boot-screen').style.display = 'none', 800);
            
            // Start AR Engine & Gesture Engine
            elements.scene.systems['mindar-image-system'].start();
            initializeHandTracking();
            
            elements.status.innerText = "SCANNING...";
        };

        /**
         * =========================================
         * MARKER TRACKING HANDLERS
         * =========================================
         */
        elements.marker.addEventListener('targetFound', () => {
            isMarkerFound = true;
            
            if (state === config.STATES.AR) {
                elements.zoom.classList.add('visible');
            }
            
            // Show AR ONLY if user isn't currently carrying a payload from another room
            if (!isPayloadGrabbed && state !== config.STATES.STABLE) {
                elements.rig.setAttribute('visible', 'true');
                if (activeMediaEl) activeMediaEl.play();
            } else if (isPayloadGrabbed) {
                elements.rig.setAttribute('visible', 'false');
            }
            
            updateStatusPill();
        });

        elements.marker.addEventListener('targetLost', () => {
            isMarkerFound = false;
            
            if (state === config.STATES.AR) {
                elements.zoom.classList.remove('visible');
            }
            if (activeMediaEl) {
                activeMediaEl.pause(); 
            }
            
            updateStatusPill();
        });

        function getScreenPosition(obj) {
            obj.updateMatrixWorld(true);
            const vec = new THREE.Vector3();
            vec.setFromMatrixPosition(obj.matrixWorld);
            vec.project(elements.scene.camera);
            return { 
                x: (vec.x * 0.5) * window.innerWidth, 
                y: -(vec.y * 0.5) * window.innerHeight 
            };
        }

        /**
         * =========================================
         * USER INTERACTION HANDLERS
         * =========================================
         */
        
        elements.zoom.onclick = () => {
            if (inTransition) return;
            const levels = [1, 2, 3, 4, 6];
            zoomLevel = levels[(levels.indexOf(zoomLevel) + 1) % levels.length];
            elements.zoom.innerText = zoomLevel + 'X';
            
            elements.rig.setAttribute('animation__scale', { 
                property: 'scale', 
                to: `${zoomLevel} ${zoomLevel} ${zoomLevel}`, 
                dur: 500, 
                easing: 'easeOutBack' 
            });
        };

        window.addEventListener('touchstart', (e) => {
            if (state !== config.STATES.AR || !isMarkerFound || inTransition || e.target.closest('button') || e.target.closest('select') || isPayloadGrabbed) return;
            
            inTransition = true;
            state = config.STATES.IMMERSIVE;
            
            elements.blur.classList.add('active');
            elements.menu.classList.add('visible');
            elements.zoom.style.transform = "translateX(-50%) translateY(-140px)";

            elements.rig.setAttribute('animation__pos', { property: 'position', to: '0 0 1.2', dur: 900, easing: 'easeOutQuart' });
            elements.rig.setAttribute('animation__scale', { property: 'scale', to: '2 2 2', dur: 900, easing: 'easeOutQuart' });
            
            setTimeout(() => inTransition = false, 950);
        });

        elements.stable.onclick = async () => {
            if (inTransition) return;
            inTransition = true;

            if (state === config.STATES.IMMERSIVE) {
                state = config.STATES.STABLE;
                elements.stable.classList.add('active');
                elements.stable.innerText = "STABLE: ON";

                if (activeMediaEl) activeMediaEl.pause();

                const pos = getScreenPosition(elements.mesh.object3D);
                const startScale = config.TRANS_SCALE * zoomLevel;

                elements.sandbox.style.transition = 'none';
                elements.sandbox.style.transform = `translate(calc(-50% + ${pos.x}px), calc(-50% + ${pos.y}px)) scale(${startScale})`;
                elements.sandbox.style.opacity = '1';
                elements.sandbox.style.zIndex = '35';
                elements.sandbox.offsetHeight;

                elements.rig.setAttribute('visible', 'false');

                elements.sandbox.style.transition = 'transform 0.8s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.5s ease';
                elements.sandbox.style.transform = 'translate(-50%, -50%) scale(1)';
                elements.sandbox.style.pointerEvents = 'auto';
                
                setTimeout(() => inTransition = false, 850);

            } else {
                if (!isMarkerFound) { 
                    alert("Point camera at Stickykode to unlock!"); 
                    inTransition = false; 
                    return; 
                }
                
                const nativeMedia = elements.target.querySelector('video, audio, iframe');
                if (nativeMedia && typeof nativeMedia.pause === 'function') nativeMedia.pause();
                else if (nativeMedia && nativeMedia.tagName === 'IFRAME') nativeMedia.src = nativeMedia.src; 

                await update3DTexture();
                state = config.STATES.IMMERSIVE;
                
                elements.stable.classList.remove('active');
                elements.stable.innerText = "STABLE: OFF";
                elements.sandbox.style.pointerEvents = 'none';

                const pos = getScreenPosition(elements.mesh.object3D);
                elements.sandbox.style.transition = 'transform 0.7s cubic-bezier(0.25, 1, 0.5, 1)';
                elements.sandbox.style.transform = `translate(calc(-50% + ${pos.x}px), calc(-50% + ${pos.y}px)) scale(${config.TRANS_SCALE * zoomLevel})`;

                setTimeout(() => {
                    elements.sandbox.style.opacity = '0';
                    elements.sandbox.style.zIndex = '-1';
                    
                    if (!isPayloadGrabbed) {
                        elements.rig.setAttribute('visible', 'true');
                        if (activeMediaEl && isMarkerFound) activeMediaEl.play();
                    }
                    inTransition = false;
                }, 750);
            }
        };

        elements.release.onclick = async () => {
            if (inTransition) return;
            inTransition = true;
            const wasStable = state === config.STATES.STABLE;
            state = config.STATES.AR;

            elements.blur.classList.remove('active');
            elements.menu.classList.remove('visible');
            elements.zoom.style.transform = "translateX(-50%) translateY(0)";
            elements.stable.classList.remove('active');
            elements.stable.innerText = "STABLE: OFF";

            if (wasStable) {
                const nativeMedia = elements.target.querySelector('video, audio, iframe');
                if (nativeMedia && typeof nativeMedia.pause === 'function') nativeMedia.pause();
                else if (nativeMedia && nativeMedia.tagName === 'IFRAME') nativeMedia.src = nativeMedia.src; 

                elements.sandbox.style.transition = 'transform 0.7s cubic-bezier(0.8, -0.4, 0.2, 1), opacity 0.5s ease';
                elements.sandbox.style.transform = 'translate(-50%, 150%) scale(0.2)';
                elements.sandbox.style.opacity = '0';
                
                setTimeout(async () => {
                    await update3DTexture();
                    elements.sandbox.style.zIndex = '-1';
                    elements.rig.setAttribute('position', '0 0 0');
                    elements.rig.setAttribute('scale', `${zoomLevel} ${zoomLevel} ${zoomLevel}`);
                    
                    if (!isPayloadGrabbed) {
                        elements.rig.setAttribute('visible', 'true');
                        if (activeMediaEl && isMarkerFound) activeMediaEl.play();
                    }
                    inTransition = false;
                }, 750);
            } else {
                elements.rig.setAttribute('animation__pos', { property: 'position', to: '0 0 0', dur: 850, easing: 'easeOutQuart' });
                elements.rig.setAttribute('animation__scale', { property: 'scale', to: `${zoomLevel} ${zoomLevel} ${zoomLevel}`, dur: 850, easing: 'easeOutQuart' });
                setTimeout(() => inTransition = false, 900);
            }
        };
    </script>
</body>
</html>
